#include "stdafx.h"
#include "screenshot.h"

bool saveBitmap(LPCSTR filename, HBITMAP bmp, HPALETTE pal)
{
	bool result = false;

	// PICTDESC contains parameters to create a picture object 
	PICTDESC picDesc;

	picDesc.cbSizeofstruct = sizeof(PICTDESC);
	picDesc.picType = PICTYPE_BITMAP;
	picDesc.bmp.hbitmap = bmp;
	picDesc.bmp.hpal = pal;

	// create picture object
	LPPICTURE picture;
	HRESULT res = OleCreatePictureIndirect
	(
		&picDesc, IID_IPicture,
		false,
		(void**)(&picture)
	);

	if (!SUCCEEDED(res))
		return false;

	// creates a stream object that uses an HGLOBAL memory handle to store the stream contents
	LPSTREAM stream;
	res = CreateStreamOnHGlobal(0, true, &stream);

	if (!SUCCEEDED(res))
	{
		picture->Release();
		return false;
	}

	// save picture to stream
	LONG bytes_streamed;
	res = picture->SaveAsFile(stream, true, &bytes_streamed);

	HANDLE file = CreateFileA
	(
		filename,
		GENERIC_WRITE,
		FILE_SHARE_READ,
		0,
		CREATE_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		0
	);

	if (!SUCCEEDED(res) || !file)
	{
		stream->Release();
		picture->Release();
		return false;
	}

	HGLOBAL mem = 0;
	// retrieves a pointer to first byte of stream memory
	GetHGlobalFromStream(stream, &mem);
	LPVOID data = GlobalLock(mem);

	DWORD bytes_written;

	// write stream memory to created file
	result = !!WriteFile(file, data, bytes_streamed, &bytes_written, 0);
	result &= (bytes_written == (DWORD)(bytes_streamed));

	GlobalUnlock(mem);
	CloseHandle(file);

	stream->Release();
	picture->Release();

	return result;
}

bool screenCapturePart(int x, int y, int w, int h, LPCSTR fname)
{
	// retrieve a handle to a device context (DC) for the entire screen.
	HDC hdcSource = GetDC(NULL);
	HDC hdcMemory = CreateCompatibleDC(hdcSource);

	// retreive device speicific info
	int xCap = GetDeviceCaps(hdcSource, HORZRES);
	int yCap = GetDeviceCaps(hdcSource, VERTRES);

	// creates a bitmap compatible with the device
	HBITMAP hBitmap = CreateCompatibleBitmap(hdcSource, w, h);
	HBITMAP hBitmapOld = (HBITMAP)SelectObject(hdcMemory, hBitmap);

	// perform a bit-block transfer of the color data
	BitBlt(hdcMemory, 0, 0, w, h, hdcSource, x, y, SRCCOPY);
	hBitmap = (HBITMAP)SelectObject(hdcMemory, hBitmapOld);

	// delete device context
	DeleteDC(hdcSource);
	DeleteDC(hdcMemory);

	HPALETTE hpal = NULL;
	if (saveBitmap(fname, hBitmap, hpal)) return true;
	return false;
}

void getDesktopResolution(int& horizontal, int& vertical)
{
	RECT desktop;

	// handle to desktop window
	const HWND hDesktop = GetDesktopWindow();

	// get size of widndow
	GetWindowRect(hDesktop, &desktop);

	horizontal = desktop.right;
	vertical = desktop.bottom;
}

std::string getCurrentDateTime()
{
	time_t now = time(NULL);
	struct tm tstruct;
	char buf[20];
	tstruct = *localtime(&now);
	strftime(buf, sizeof(buf), "%m-%d-%Y_%X", &tstruct);
	std::string time = buf;
	std::replace(time.begin(), time.end(), ':', '-');
	return time;
}